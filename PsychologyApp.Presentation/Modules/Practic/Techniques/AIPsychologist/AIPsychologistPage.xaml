<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MobileHelperMaui.Views.TechniquePages.AIPsychologistPage"
             xmlns:vm="clr-namespace:PsychologyApp.Presentation.Modules.Practic.Techniques.AIPsychologist"
             xmlns:templates="clr-namespace:PsychologyApp.Presentation.Templates"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             xmlns:local="clr-namespace:PsychologyApp.Presentation.Modules.Practic.Techniques.AIPsychologist"
             Title="ИИ-психолог"
             BackgroundColor="{StaticResource Gray100}">
    
    <ContentPage.BindingContext>
        <vm:AIPsychologistViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="Accent">#96d1ff</Color>
            <Color x:Key="TelegramUserMessageBg">#0085FF</Color>
            <Color x:Key="TelegramAIMessageBg">#FFFFFF</Color>
            <Color x:Key="TelegramChatBackground">#E5E5E5</Color>
            <Color x:Key="TelegramInputBackground">#FFFFFF</Color>
            <Color x:Key="TelegramUserMessageText">#FFFFFF</Color>
            <Color x:Key="TelegramAIMessageText">#000000</Color>
            <Color x:Key="TelegramTimestampColor">#999999</Color>
            <Color x:Key="TelegramAvatarBg">#0085FF</Color>
            
            <local:BoolToColorConverter x:Key="BoolToColorConverter" />
            <local:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            
            <!-- Telegram стиль для сообщений пользователя (справа) -->
            <Style x:Key="TelegramUserMessageStyle" TargetType="Frame">
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="12, 8, 10, 8" />
                <Setter Property="Margin" Value="50, 2, 8, 2" />
                <Setter Property="BackgroundColor" Value="{StaticResource TelegramUserMessageBg}" />
                <Setter Property="BorderColor" Value="Transparent" />
            </Style>
            
            <!-- Telegram стиль для сообщений AI (слева) -->
            <Style x:Key="TelegramAIMessageStyle" TargetType="Frame">
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="12, 8, 10, 8" />
                <Setter Property="Margin" Value="8, 2, 50, 2" />
                <Setter Property="BackgroundColor" Value="{StaticResource TelegramAIMessageBg}" />
                <Setter Property="BorderColor" Value="Transparent" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" 
          VerticalOptions="FillAndExpand"
          BackgroundColor="{StaticResource TelegramChatBackground}">

        <!-- Navigation Bar -->
        <templates:NavigationBarExtendedView
            Grid.Row="0"
            TitleText="ИИ-психолог"
            BackCommand="{Binding Finish}"/>

        <!-- Main Chat Area -->
        <Grid Grid.Row="1" 
              RowDefinitions="*,Auto"
              Margin="0, 5, 0, 0">

            <!-- Chat Messages Area -->
            <ScrollView 
                Grid.Row="0"
                x:Name="ChatScrollView"
                VerticalScrollBarVisibility="Never"
                VerticalOptions="FillAndExpand">
                
                <StackLayout 
                    x:Name="MessagesContainer"
                    Spacing="0"
                    Padding="8, 8, 8, 8"
                    BindableLayout.ItemsSource="{Binding Messages}">
                    
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <!-- Сообщение пользователя (Telegram стиль - справа) -->
                                <Grid 
                                    IsVisible="{Binding IsUser}"
                                    ColumnDefinitions="*,Auto"
                                    Margin="50, 2, 8, 2">
                                    
                                    <Frame 
                                        Grid.Column="1"
                                        Style="{StaticResource TelegramUserMessageStyle}">
                                        <Grid RowDefinitions="Auto,Auto">
                                            <Label 
                                                Grid.Row="0"
                                                Text="{Binding Text}"
                                                FontSize="15"
                                                FontFamily="RobotoRegular"
                                                TextColor="{StaticResource TelegramUserMessageText}"
                                                LineBreakMode="WordWrap"
                                                Margin="0, 0, 0, 4"/>
                                            
                                            <Grid 
                                                Grid.Row="1"
                                                ColumnDefinitions="*,Auto"
                                                ColumnSpacing="4"
                                                Margin="0, 2, 0, 0">
                                                <BoxView Grid.Column="0" Color="Transparent" />
                                                <Label 
                                                    Grid.Column="1"
                                                    Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                    FontSize="12"
                                                    FontFamily="RobotoRegular"
                                                    TextColor="#B3FFFFFF"
                                                    Opacity="0.9"
                                                    VerticalOptions="End"/>
                                            </Grid>
                                        </Grid>
                                    </Frame>
                                </Grid>
                                
                                <!-- Сообщение AI (Telegram стиль - слева) -->
                                <Grid 
                                    IsVisible="{Binding IsUser, Converter={StaticResource InvertedBoolConverter}}"
                                    ColumnDefinitions="Auto,*"
                                    Margin="8, 2, 50, 2">
                                    
                                    <!-- Аватар AI (Telegram стиль) -->
                                    <Frame 
                                        Grid.Column="0"
                                        WidthRequest="32"
                                        HeightRequest="32"
                                        HasShadow="False"
                                        BorderColor="Transparent"
                                        BackgroundColor="{StaticResource TelegramAvatarBg}"
                                        CornerRadius="16"
                                        Padding="0"
                                        Margin="0, 0, 6, 0"
                                        VerticalOptions="Start">
                                        <Label 
                                            Text="AI"
                                            FontSize="11"
                                            FontFamily="RobotoMedium"
                                            TextColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center"/>
                                    </Frame>
                                    
                                    <Frame 
                                        Grid.Column="1"
                                        Style="{StaticResource TelegramAIMessageStyle}">
                                        <Grid RowDefinitions="Auto,Auto">
                                            <Label 
                                                Grid.Row="0"
                                                Text="{Binding Text}"
                                                FontSize="15"
                                                FontFamily="RobotoRegular"
                                                TextColor="{StaticResource TelegramAIMessageText}"
                                                LineBreakMode="WordWrap"
                                                Margin="0, 0, 0, 4"/>
                                            
                                            <Grid 
                                                Grid.Row="1"
                                                ColumnDefinitions="*,Auto"
                                                ColumnSpacing="4"
                                                Margin="0, 2, 0, 0">
                                                <BoxView Grid.Column="0" Color="Transparent" />
                                                <Label 
                                                    Grid.Column="1"
                                                    Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                    FontSize="12"
                                                    FontFamily="RobotoRegular"
                                                    TextColor="{StaticResource TelegramTimestampColor}"
                                                    Opacity="0.7"
                                                    VerticalOptions="End"/>
                                            </Grid>
                                        </Grid>
                                    </Frame>
                                </Grid>
                            </Grid>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
            </ScrollView>

            <!-- Индикатор загрузки в стиле Telegram -->
            <Grid 
                Grid.Row="0"
                IsVisible="{Binding IsLoading}"
                BackgroundColor="Transparent">
                <ActivityIndicator 
                    IsRunning="{Binding IsLoading}"
                    Color="{StaticResource Primary}"
                    WidthRequest="24"
                    HeightRequest="24"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    Margin="0, 0, 0, 80"/>
            </Grid>

            <!-- Поле ввода в стиле Telegram -->
            <Grid 
                Grid.Row="1"
                RowDefinitions="Auto"
                BackgroundColor="{StaticResource TelegramInputBackground}"
                Padding="8, 8, 8, 8">
                
                <Grid 
                    ColumnDefinitions="*,Auto"
                    ColumnSpacing="8"
                    VerticalOptions="Center">
                    
                    <!-- Поле ввода Telegram стиль -->
                    <Frame 
                        Grid.Column="0"
                        HasShadow="False"
                        BorderColor="Transparent"
                        BackgroundColor="{StaticResource Gray100}"
                        CornerRadius="20"
                        Padding="16, 10">
                        <Entry 
                            Text="{Binding UserMessage}"
                            Placeholder="Сообщение"
                            FontSize="15"
                            FontFamily="RobotoRegular"
                            PlaceholderColor="{StaticResource Gray400}"
                            TextColor="{StaticResource Gray900}"
                            BackgroundColor="Transparent"
                            ReturnCommand="{Binding SendMessageCommand}"
                            ClearButtonVisibility="Never"/>
                    </Frame>
                    
                    <!-- Кнопка отправки Telegram стиль -->
                    <Frame 
                        Grid.Column="1"
                        HasShadow="False"
                        BorderColor="Transparent"
                        BackgroundColor="{StaticResource Primary}"
                        CornerRadius="20"
                        WidthRequest="40"
                        HeightRequest="40"
                        Padding="0">
                        <Button 
                            Text="→"
                            FontSize="18"
                            FontFamily="RobotoMedium"
                            TextColor="White"
                            BackgroundColor="Transparent"
                            Command="{Binding SendMessageCommand}"
                            IsEnabled="{Binding IsNotLoading}"
                            Padding="0"
                            Margin="0"/>
                    </Frame>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
