<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MobileHelperMaui.Views.TechniquePages.AIPsychologistPage"
             xmlns:vm="clr-namespace:PsychologyApp.Presentation.Modules.Practic.Techniques.AIPsychologist"
             xmlns:templates="clr-namespace:PsychologyApp.Presentation.Templates"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             xmlns:local="clr-namespace:PsychologyApp.Presentation.Modules.Practic.Techniques.AIPsychologist"
             Title="ИИ-психолог"
             BackgroundColor="{StaticResource Gray100}">
    
    <ContentPage.BindingContext>
        <vm:AIPsychologistViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="Accent">#96d1ff</Color>
            <Color x:Key="TechniqueTextColor">#DE000000</Color>
            <Color x:Key="TechniqueGrayColor">#AAAAAA</Color>
            
            <local:BoolToColorConverter x:Key="BoolToColorConverter" />
            <local:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            
            <!-- Стиль для сообщений пользователя в стиле техник (справа) -->
            <Style x:Key="UserMessageStyle" TargetType="Frame">
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="12, 10, 12, 10" />
                <Setter Property="Margin" Value="50, 4, 8, 4" />
                <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                <Setter Property="BorderColor" Value="Transparent" />
            </Style>
            
            <!-- Стиль для сообщений AI в стиле техник (слева) -->
            <Style x:Key="AIMessageStyle" TargetType="Frame">
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="Padding" Value="12, 10, 12, 10" />
                <Setter Property="Margin" Value="8, 4, 50, 4" />
                <Setter Property="BackgroundColor" Value="{StaticResource White}" />
                <Setter Property="BorderColor" Value="Transparent" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" 
          VerticalOptions="FillAndExpand"
          BackgroundColor="{StaticResource White}">

        <!-- Navigation Bar -->
        <templates:NavigationBarExtendedView
            Grid.Row="0"
            TitleText="ИИ-психолог"
            BackCommand="{Binding Finish}"/>

        <!-- Main Chat Area -->
        <Grid Grid.Row="1" 
              RowDefinitions="*,Auto"
              Margin="0, 5, 0, 0">

            <!-- Chat Messages Area -->
            <ScrollView 
                Grid.Row="0"
                x:Name="ChatScrollView"
                VerticalScrollBarVisibility="Never"
                VerticalOptions="FillAndExpand">
                
                <StackLayout 
                    x:Name="MessagesContainer"
                    Spacing="0"
                    Padding="10, 10, 10, 10"
                    BindableLayout.ItemsSource="{Binding Messages}">
                    
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <!-- Сообщение пользователя в стиле техник (справа) -->
                                <Grid 
                                    IsVisible="{Binding IsUser}"
                                    ColumnDefinitions="*,Auto"
                                    Margin="50, 4, 8, 4"
                                    VerticalOptions="Start">
                                    
                                    <Frame 
                                        Grid.Column="1"
                                        Style="{StaticResource UserMessageStyle}"
                                        VerticalOptions="Start">
                                        <Grid RowDefinitions="Auto,Auto">
                                            <Label 
                                                Grid.Row="0"
                                                Text="{Binding Text}"
                                                FontSize="15"
                                                FontFamily="RobotoRegular"
                                                TextColor="White"
                                                LineBreakMode="WordWrap"
                                                Margin="0, 0, 0, 4"/>
                                            
                                            <Grid 
                                                Grid.Row="1"
                                                ColumnDefinitions="*,Auto"
                                                ColumnSpacing="4"
                                                Margin="0, 2, 0, 0">
                                                <BoxView Grid.Column="0" Color="Transparent" />
                                                <Label 
                                                    Grid.Column="1"
                                                    Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                    FontSize="12"
                                                    FontFamily="RobotoRegular"
                                                    TextColor="#B3FFFFFF"
                                                    Opacity="0.9"
                                                    VerticalOptions="End"/>
                                            </Grid>
                                        </Grid>
                                    </Frame>
                                </Grid>
                                
                                <!-- Сообщение AI в стиле техник (слева) -->
                                <Grid 
                                    IsVisible="{Binding IsUser, Converter={StaticResource InvertedBoolConverter}}"
                                    ColumnDefinitions="Auto,*"
                                    Margin="8, 4, 50, 4"
                                    VerticalOptions="Start">
                                    
                                    <!-- Аватар AI в стиле техник -->
                                    <Frame 
                                        Grid.Column="0"
                                        WidthRequest="32"
                                        HeightRequest="32"
                                        HasShadow="True"
                                        BorderColor="Transparent"
                                        BackgroundColor="{StaticResource Primary}"
                                        CornerRadius="16"
                                        Padding="0"
                                        Margin="0, 0, 6, 0"
                                        VerticalOptions="Start">
                                        <Label 
                                            Text="AI"
                                            FontSize="11"
                                            FontFamily="RobotoMedium"
                                            TextColor="White"
                                            HorizontalOptions="Center"
                                            VerticalOptions="Center"/>
                                    </Frame>
                                    
                                    <Frame 
                                        Grid.Column="1"
                                        Style="{StaticResource AIMessageStyle}"
                                        VerticalOptions="Start">
                                        <Grid RowDefinitions="Auto,Auto">
                                            <Label 
                                                Grid.Row="0"
                                                Text="{Binding Text}"
                                                FontSize="15"
                                                FontFamily="RobotoRegular"
                                                TextColor="{StaticResource TechniqueTextColor}"
                                                LineBreakMode="WordWrap"
                                                Margin="0, 0, 0, 4"/>
                                            
                                            <Grid 
                                                Grid.Row="1"
                                                ColumnDefinitions="*,Auto"
                                                ColumnSpacing="4"
                                                Margin="0, 2, 0, 0">
                                                <BoxView Grid.Column="0" Color="Transparent" />
                                                <Label 
                                                    Grid.Column="1"
                                                    Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                    FontSize="12"
                                                    FontFamily="RobotoRegular"
                                                    TextColor="{StaticResource TechniqueGrayColor}"
                                                    Opacity="0.8"
                                                    VerticalOptions="End"/>
                                            </Grid>
                                        </Grid>
                                    </Frame>
                                </Grid>
                            </Grid>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
            </ScrollView>

            <!-- Индикатор загрузки в стиле техник -->
            <Grid 
                Grid.Row="0"
                IsVisible="{Binding IsLoading}"
                BackgroundColor="Transparent">
                <ActivityIndicator 
                    IsRunning="{Binding IsLoading}"
                    Color="{StaticResource Primary}"
                    WidthRequest="24"
                    HeightRequest="24"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    Margin="0, 0, 0, 80"/>
            </Grid>

            <!-- Поле ввода в стиле техник -->
            <Grid 
                Grid.Row="1"
                RowDefinitions="Auto"
                BackgroundColor="{StaticResource White}"
                Padding="10, 10, 10, 10">
                
                <Grid 
                    ColumnDefinitions="*,Auto"
                    ColumnSpacing="8"
                    VerticalOptions="Center">
                    
                    <!-- Поле ввода в стиле техник -->
                    <Frame
                        Grid.Column="0"
                        HasShadow="True"
                        BorderColor="Transparent"
                        BackgroundColor="{StaticResource White}"
                        CornerRadius="25"
                        Padding="16, 10">
                        <Entry 
                            x:Name="MessageEntry"
                            Text="{Binding UserMessage}"
                            Placeholder="Сообщение"
                            FontSize="15"
                            FontFamily="RobotoRegular"
                            PlaceholderColor="{StaticResource TechniqueGrayColor}"
                            TextColor="{StaticResource TechniqueTextColor}"
                            BackgroundColor="Transparent"
                            Keyboard="Text"
                            ReturnCommand="{Binding SendMessageCommand}"
                            ClearButtonVisibility="Never"/>
                    </Frame>
                    
                    <!-- Кнопка отправки в стиле техник -->
                    <Frame 
                        Grid.Column="1"
                        HasShadow="True"
                        BorderColor="Transparent"
                        BackgroundColor="{StaticResource Primary}"
                        CornerRadius="20"
                        WidthRequest="40"
                        HeightRequest="40"
                        Padding="0">
                        <Button 
                            Text="→"
                            FontSize="18"
                            FontFamily="RobotoMedium"
                            TextColor="White"
                            BackgroundColor="Transparent"
                            Command="{Binding SendMessageCommand}"
                            IsEnabled="{Binding IsNotLoading}"
                            Padding="0"
                            Margin="0"/>
                    </Frame>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
